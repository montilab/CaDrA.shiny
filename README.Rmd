---
output: rmarkdown::github_document
---

<!-- README.md is generated from README.Rmd. Please edit this file -->

```{r, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(fig.path="./man/figures/", message=FALSE, collapse=FALSE, comment="")

# Load R packages
library(devtools)
load_all()
library(knitr)
library(GSVA)
library(CaDrA)
library(hypeR)
```

<p style="font-size: 40pt; front-weight: bold; padding-bottom: 0px; margin-bottom: 0;">CaDrA.shiny</p>

<hr style="padding-top: 0; margin-top: 0;">

![build](https://github.com/montilab/cadra/workflows/rcmdcheck/badge.svg)
![Gitter](https://img.shields.io/gitter/room/montilab/cadra.shiny)
![GitHub issues](https://img.shields.io/github/issues/montilab/cadra.shiny)
![GitHub last commit](https://img.shields.io/github/last-commit/montilab/cadra.shiny)

An R Shiny Dashboard for Interacting with **[CaDrA](https://montilab.github.io/CaDrA/)** Package 

### **CaDrA: [https://montilab.github.io/CaDrA/](https://montilab.github.io/CaDrA/)**

### **Web Portal: [https://cadra.bu.edu/](https://cadra.bu.edu/)**

## Overview

**CaDrA-shiny** is an interactive R Shiny dashboard that is developed to allow users to directly interacting with **CaDrA** package. **CaDrA** is an R package that supports a heuristic search framework aimed at identifying candidate drivers of a molecular phenotype of interest (visit [our Github repo](https://github.com/montilab/CaDrA) for more details). 

The CaDrA's shiny dashboard has two distinctive features:

1. Run **CaDrA** search to identify candidate drivers of a molecular phenotype of interest
2. Run **GSVA** to obtain relative enrichment scores for a given gene sets, then subsequently, these scores are used to run **CaDrA** search to look for complementary features that likely driving the input of molecular phenotype. 

Data visualization includes:

- Meta-feature plot 
- Kolmogorov Smirnov (KS) enrichment plot
- Top N candidates overlapping heatmap
- Permutation plot 

The **CaDrA.shiny** package is already containerized using **Docker** and can be deployed on any Cloud-based services.

#### **Docker image: [montilab/cadra-shiny](https://hub.docker.com/r/montilab/cadra-shiny)**

####  Useful Guides

- <a href="articles/docker.html" target="_blank">Containerizing CaDrA.shiny with Docker</a>
- <a href="articles/docker-compose.html" target="_blank">Launching CaDrA's Shiny Dashboard with Compose</a>

### (1) Installation

```r
library(devtools)
devtools::install_github("montilab/CaDrA.shiny")
```

### (2) Load packages

```r
library(CaDrA.shiny)
library(CaDrA)
library(GSVA)
library(knitr)
library(hypeR)
```

### (3) Run CaDrA with dataset downloaded from CaDrA Portal

#### (i) Retrieve a list of pre-processed feature sets available on the portal

```{r}
# Get a list of feature sets available on CaDrA Portal
fs_list <- CaDrA.shiny::get_feature_set(order_by="asc")
```

```{r}
# Look at the first 6 feature sets
knitr::kable(head(fs_list))
```

#### (ii) Pull down datasets from the portal

```{r}
datasets <- CaDrA.shiny::pull_datasets(
  feature_set = "TCGA_ACC_2016_01_28_GISTIC_MUT_SIG",
  include_gene_expression = TRUE
)
datasets
```

#### (iii) Run GSVA with downloaded datasets

```{r}
## download MSigDBâ€™s Hallmark genesets
hallmarks <- msigdb_gsets("Homo sapiens", "H", clean=TRUE)$genesets # returns 50 genesets 

# Compute the gsva scores of the first 10 features
input_score_matrix <- GSVA::gsva(
  expr = SummarizedExperiment::assay(datasets$gene_expression), 
  gset.idx.list = hallmarks,
  method = "gsva",
  mx.diff = TRUE,
  verbose = FALSE
)
```

```{r}
## Look at the gsva scores of the first 10 features
knitr::kable(input_score_matrix[1:5,1:5])
```

#### (iv) Run candidate search with input scores obtained in (iii)

```{r}

## Samples to keep based on the overlap between the two inputs
overlap <- intersect(colnames(input_score_matrix), colnames(datasets$feature_set))
input_score <- input_score_matrix["Epithelial Mesenchymal Transition", overlap]
FS <- datasets$feature_set[, overlap, drop=FALSE]

## Pre-filter FS based on occurrence frequency
FS_filtered <- CaDrA::prefilter_data(
  FS = FS,
  max_cutoff = 0.6,  # max event frequency (60%)
  min_cutoff = 0.03  # min event frequency (3%)
)  
## Run candidate search
topn_result <- CaDrA::candidate_search(
  FS = FS_filtered,
  input_score = input_score,
  method = "ks_pval",      # Use Kolmogorow-Smirnow scoring function 
  weights = NULL,          # If weights is provided, perform a weighted-KS test
  alternative = "less",    # Use one-sided hypothesis testing
  search_method = "both",  # Apply both forward and backward search
  top_N = 1,               # Evaluate top 1 starting points for each search
  max_size = 7,            # Maximum size a meta-feature matrix can extend to
  do_plot = FALSE,         # Plot after finding the best features
  best_score_only = FALSE  # Return meta-feature set, observed input scores and calculated best score
)
```

### (v) Visualize Best Results

```{r}
## Fetch the meta-feature set corresponding to its best scores over top N features searches
topn_best_meta <- CaDrA::topn_best(topn_result)

## Visualize the best results with the meta-feature plot
CaDrA::meta_plot(topn_best_list = topn_best_meta, input_score_label = NULL)
```

```{r}
## Set seed for permutation
set.seed(123)

## Run CaDrA Search
perm_res <- CaDrA::CaDrA(
  FS = FS_filtered, 
  input_score = input_score, 
  method = "ks_pval",
  top_N = 1,
  max_size = 7,
  search_method = "both",     
  n_perm = 1000,
  ncores = 1
)
## Visualize permutation results
permutation_plot(perm_res = perm_res)
```

### (4) Launch CaDrA's Shiny App with your pre-proccessed dataset

#### (i) Pull pre-processed feature sets using our REST API

```{r}
# Download feature sets and return a datalist with appropriate paths to dataset
mydatafile <- CaDrA.shiny::download_feature_sets(
  #feature_set = fs_list$feature_set_name,  # this would download all TCGA datasets
  feature_set = "TCGA_ACC_2016_01_28_GISTIC_MUT_SIG",
  include_input_score = TRUE,
  include_gene_expression = TRUE,
  out_dir = file.path(Sys.getenv("HOME"),"Github") # specify your folder of choice here
)
```

```{r}
# Look at the top 6 rows
knitr::kable(head(mydatafile))
```

#### (iii) Launch CaDrA's app with the downloaded dataset

```r
# Launch CaDrA's Shiny app with your downloaded datalist retrieved from (ii)
app <- CaDrA.shiny::CaDrA_App(id="myapp", datalist=mydatafile)

# Launch app on localhost with port 3838
shiny::runApp(app, host='0.0.0.0', port=3838)
```

# A Glimpse of CaDrA's Dashboard

There are five tabs on CaDrA's Dashboard. Explore each tab and see what they do:

![](man/figures/tabs.png)

- <a href="articles/run-cadra-tab.html" target="_blank">Run CaDrA</a>
- <a href="articles/run-gsva-tab.html" target="_blank">Run GSVA</a>
- <a href="articles/api.html" target="_blank">Download</a>
- Help
- Publication
- Contract Us

# Getting Help

To get help with **CaDrA**, visit our [Github dicussion](https://github.com/montilab/CaDrA/discussions) or [Github issues](https://github.com/montilab/CaDrA/issues).

To get help with **CaDrA.shiny**, visit our [Github dicussion](https://github.com/montilab/CaDrA.shiny/discussions) or [Github issues](https://github.com/montilab/CaDrA.shiny/issues).


